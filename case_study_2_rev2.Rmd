---
title: "case_study_2"
author: "Travis Deason"
date: "12/4/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE}
rm( list = ls()); cat("\014")  # Clear environment
#install.packages('tidyr')
#install.packages('dplyr')
#install.packages('ggplot2')
#install.packages('Hmisc')
#install.packages('plotly')
#install.packages('stringr)
library(stringr)
library(plotly)
library(Hmisc)
library(tidyr)
library(dplyr)
library(ggplot2)
source('src/deason_functions.R')
data <- read.csv('data/CaseStudy2-data.csv')
describe_data <- read.csv('data/CaseStudy2-descriptions.csv')
#names(describe_data) <- (names(describe_data), tolower)
names(data) <- sapply(names(data), tolower)
```
## Project Goals

* Identify (at least) the top three factors that contribute to turnover.

* Learn about any job role specific trends that may exist in the data set

* Provide any other interesting trends and observations from your analysis

* Because we have a mix of catagoriacal and numerical data in here, I am going to split every integer column into binned values

```{r}
#function defined in deason_functions.R
data_binned <- bin_columns(data, 100, 10)
```

* Now, lets find out the base attrition rate

```{r}
na_count <- sum(is.na(data$attrition))
## convert data Attrition to binary
data_binned$attrition <- data$attrition == 'Yes'
## N/A Count
print(sum(na_count))
## Sum of Employees who quit
print(sum(data_binned$attrition))
## retain ratio
overall_ratio <- sum(data_binned$attrition) / length(data_binned$attrition)
print(overall_ratio)
```


* So, there are no N/A values in attrition
* 237 total employees quit out of 1470 total (which is 16.122 percent)


* Now (Since we have binned all continous values) lets treat all values as catagorical, and find out which of them have a higher then expected corelation with

* First we will create a vector which contains the lengths of all catagories, or factors

```{r}
num_obs <- find_number_observations(data_binned, sep='&')
print(mean(num_obs))

obs_stacked = stack(num_obs)
ggplot(obs_stacked, aes(x = values)) +
  stat_density(position="identity",geom="line")
```

*It looks like we have 216 possible factors with an mean of 238 observations each, and most factors seem to have around ~170 variables, so we are fairly well distributed, but it would be nice if one of those factors with 1000+ had a zero attrition rate


```{r}
percent_pos <- find_percent(data_binned, 'attrition', num_obs)
print(mean(percent_pos))
print(median(percent_pos))
per_stacked = stack(percent_pos)
ggplot(per_stacked, aes(x = values)) +
  stat_density(position="identity",geom="line")
```

* Unsuprisingly, our mean value for percent_quit is exactly in line with the overall percent who quit, but the median value is notably lower, and we seem to have a small cluster of events hovering around .33% quit; which is approximitly double the standard rate

* Let's take a closer look at some of those varaibles

```{r}
## move all our data into a dataframe of percent_quit verses number of observations
attr_frame <- data.frame(percent_pos, num_obs)
hnames <- (rownames(attr_frame) != 'attrition&TRUE' & rownames(attr_frame) != 'attrition&FALSE')
attr_frame <- attr_frame[hnames,]
high_prob <- subset(attr_frame, percent_pos > overall_ratio)
high_prob$ratio_delta = high_prob$percent_pos - overall_ratio
hnames <- (rownames(high_prob) != 'attrition&TRUE' & rownames(high_prob) != 'attrition&FALSE')
high_prob <- high_prob[hnames,]
head(high_prob[order(-high_prob$ratio_delta),], 20)
```

* That cluster of percent quit at just over 30% is starting to look a little suspicious, like there may be a very strong covariance within those groups, which would make those varaibles slightly less valuable, but before we dig into covariance, we should check out if there is a strong coorelation at the other end of this dataframe


```{r}
head(attr_frame[order(attr_frame$percent_pos),], 20)
```

* This seems a little fishy... out of 961 research and development employees, zero of them have quit during the course of this study.  Part of the concern is that seems like an unusually low number, but it seems more suprusing that over half of the subjects surveyed in this study were in research and development.  This calls into question the sampling procedures used to collect this data.

*Otherwise, the data seems to indicate that there is a very strong coorelation between employee retention and how long an employee has been in a specific role.  That and higher income, and more senior employees in their late 30s to mid 40s tend to stick around longer

but first we are going to have to generate our dummy varaibles across the main dataset.


```{r}
# Generate covariance matrix for all high attrition attributes.
over_30 <- subset(high_prob, percent_pos > .30)
data_dummy <- make_dummy(data_binned)
covar_30 <- find_covariance(data_dummy , rownames(over_30))
covar_30
```
```{r}
abs(-5)
```


* So it looks like 62 percent of sales reps have less then 4 working years of expirence.  Younger people also were more likley to be earlier in thier carrer, Sales roles tend to have less years with thier current manager, and there are no employees who are making two seperate wages. I'd say those coorelations seem rather obvious; however, the coorealtion isn't strong enough that I would automatically remove them.  It seems safe to remove the variable for yearsatcompany.  This seems like a variable that can be well explained by others


x


*just for fun, let's see if we can find the most commonly correlated variables throughout the table

```{r}
all_covar <- find_covariance(data_dummy, names(data_dummy))
length(all_covar)
```

* since it would be hard to look at all 10,455 covariaraiant pairs, I am going to look at the histogram to see where most pairs lie

```{r}
hist(all_covar, breaks=50)
```


* It looks like most of our variables are pretty independent of the others.  It is possible the surge in perfect corelation at the top is just due to groups which have very small counts; so it's probably not worth looking much in to, but I think I would like to see some of the other items with a correlation of .8 or higher.

```{r}
head(all_covar[all_covar > .80 & all_covar < .999], 50)
sum(data_dummy[,'performancerating&3']) / 1470
print(sum(data[,'performancerating'] == 3))
sum(data[,'performancerating'] == 3 & data_binned[,'attrition'] == TRUE)
```

* it seems like there's a whole lot of fields which are highly correlated with a performance rating of 3.  Perhaps this is an indicator that a performance rating of 3 is not really a good indicator for much.  In fact, it looks like 84% of all employees surveyed had a performance rating of 3.  Additionally, 16 percent of employees with a performance rating of 3 quit, which is nearly exactly in line with the population estimate.  Overall, this variable provides no information gain.


* Now let's take a look at enviroment satisfaction.  This varaible is catagorized from 1-4, but I would like to convert it to a binary varaible, so I am going to look to see how it's distributed

```{r}
sum(data['environmentsatisfaction'] == 1) / 1470
sum(data['environmentsatisfaction'] == 2) / 1470
sum(data['environmentsatisfaction'] == 3) / 1470
sum(data['environmentsatisfaction'] == 4) / 1470
```

* It looks like 40% of all employees would rank their workplace as low or medium, and they are fairly evenly distributed; so I am going to change the environmentsatisfaction varaible so that any ratign of 1-2 is FALSE, and a rating of 3-4 is TRUE.

```{r}
source('src/deason_functions.R')
data_binned[,'environmentsatisfaction'] <- data['environmentsatisfaction'] < 3
infl <- check_label_corelation(data_binned, 'environmentsatisfaction', '&', sd_ratio=.7)
infl
```

* It looks the the features most highly coorelated with environment satisfaction are a high monthly salary, having worked at one other company before, being at a company for a long time, feeling involved at your company, and having quit your job.  It seems to also help if you are a research director

* On the other hand, there is a very large amount of datapoints which havea  0% coorelation with enviromential satisfaction.  The most suprising one is that no employee with less then 5 years with their current manager seems to be satisfied with thier enviroment.


```{r}
sum(data['education'] == 1) / 1470
sum(data['education'] == 2) / 1470
sum(data['education'] == 3) / 1470
sum(data['education'] == 4) / 1470
```

* Moving onto education, we are presented with more evidence that this sample is not indicitive of the population.  Only 11 percent of those surveyed do not have a college degree, and .65 percent have a masters degree or higher; so because of our parciluar population, we are going to make the split at graduate school (so all employees with a masters degree or higher will be associated with the label TRUE)


```{r}
source('src/deason_functions.R')
data_binned[,'education'] <- data['education'] > 2
infl <- check_label_corelation(data_binned, 'education', '&', sd_ratio=.7)
infl
```

* The most interesting thing  here is that it seems .85% of those educated in HR have a masters degree or higher.
