---
title: "case_study_2"
author: "Travis Deason"
date: "12/4/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE}
rm( list = ls()); cat("\014")  # Clear environment
#install.packages('tidyr')
#install.packages('dplyr')
#install.packages('ggplot2')
#install.packages('Hmisc')
#install.packages('plotly')
#install.packages('stringr)
library(stringr)
library(plotly)
library(Hmisc)
library(tidyr)
library(dplyr)
library(ggplot2)
library(plyr)
require(reshape2)
source('src/deason_functions.R')
data <- read.csv('data/CaseStudy2-data.csv')
data$Department <- revalue(data$Department, c('Human Resources' = 'Human Resources', 'Research & Development'='Research/Development', 'Sales'='Sales'))
describe_data <- read.csv('data/CaseStudy2-descriptions.csv')
#names(describe_data) <- (names(describe_data), tolower)
names(data) <- sapply(names(data), tolower)
```
## Project Goals

* Identify (at least) the top three factors that contribute to turnover.

* Learn about any job role specific trends that may exist in the data set

* Provide any other interesting trends and observations from your analysis

* Because we have a mix of catagoriacal and numerical data in here, I am going to split every integer column into binned values

```{r}
#function defined in deason_functions.R
data_binned <- bin_columns(data, 100, 10)
```


* Now, lets find out the base attrition rate

```{r}
na_count <- sum(is.na(data$attrition))
## convert data Attrition to binary
data_binned$attrition <- data$attrition == 'Yes'
## N/A Count
print(sum(na_count))
## Sum of Employees who quit
print(sum(data_binned$attrition))
## retain ratio
overall_ratio <- sum(data_binned$attrition) / length(data_binned$attrition)
print(overall_ratio)
```


* So, there are no N/A values in attrition
* 237 total employees quit out of 1470 total (which is 16.122 percent)


* Now (Since we have binned all continous values) lets treat all values as catagorical, and find out which of them have a higher then expected corelation with

* First we will create a vector which contains the lengths of all catagories, or factors

```{r}
num_obs <- find_number_observations(data_binned, sep='&')
print(mean(num_obs))

obs_stacked = stack(num_obs)
ggplot(obs_stacked, aes(x = values)) +
  stat_density(position="identity",geom="line")
```

*It looks like we have 216 possible factors with an mean of 238 observations each, and most factors seem to have around ~170 variables, so we are fairly well distributed, but it would be nice if one of those factors with 1000+ had a zero attrition rate


```{r}
percent_pos <- find_percent(data_binned, 'attrition', num_obs)
print(mean(percent_pos))
print(median(percent_pos))
per_stacked = stack(percent_pos)
ggplot(per_stacked, aes(x = values)) +
  stat_density(position="identity",geom="line")
```

* Unsuprisingly, our mean value for percent_quit is exactly in line with the overall percent who quit, but the median value is notably lower, and we seem to have a small cluster of events hovering around .33% quit; which is approximitly double the standard rate

* Let's take a closer look at some of those varaibles

```{r}
## move all our data into a dataframe of percent_quit verses number of observations
attr_frame <- data.frame(percent_pos, num_obs)
hnames <- (rownames(attr_frame) != 'attrition&TRUE' & rownames(attr_frame) != 'attrition&FALSE')
attr_frame <- attr_frame[hnames,]
high_prob <- subset(attr_frame, percent_pos > overall_ratio)
high_prob$ratio_delta = high_prob$percent_pos - overall_ratio
hnames <- (rownames(high_prob) != 'attrition&TRUE' & rownames(high_prob) != 'attrition&FALSE')
high_prob <- high_prob[hnames,]
head(high_prob[order(-high_prob$ratio_delta),], 20)
```

* We see that Sales Representatives is the group with the highest leaving rate. 
* The next 3 highest groups are young people with little experience, both in working years and at the company. These three groups are not independent.
* A high number of people leave at 0 years with their current manager. This could be related to inexperience/age or incompatibility with the manager.
* People with low salaries leave at a higher rate. This again could be confounded in age/experience.

It is also important to examine what factors are associated with not quitting.

```{r}
head(attr_frame[order(attr_frame$percent_pos),], 20)
```

* Research Directors have an incredibly low rate of attrition.
* Employees in the highest income bracket rarely quit.
* Employees that have worked the same role with the same manager for about a decade rarely quit.

Many of these attributes are likely correlated.

but first we are going to have to generate our dummy varaibles across the main dataset.


```{r}
# Generate covariance matrix for all high attrition attributes.
source('src/deason_functions.R')
over_30 <- subset(high_prob, percent_pos > .30)
data_dummy <- make_dummy(data_binned)
covar_30 <- find_covariance(data_dummy , rownames(over_30))
covar_30
```


* So it looks like 62 percent of sales reps have less then 4 working years of experience.  Younger people also were more likley to be earlier in thier carrer, Sales roles tend to have less years with thier current manager. I'd say these correlations are logical; however, the correlation isn't strong enough that I would automatically remove them.  It seems safe to remove the variable for yearsatcompany.  This seems like a variable that can be well explained by others


*just for fun, let's see if we can find the most commonly correlated variables throughout the table

```{r}
all_covar <- find_covariance(data_dummy, names(data_dummy))
length(all_covar)
```

* since it would be hard to look at all 10,455 covariaraiant pairs, we will look at the histogram to see where most pairs lie

```{r}
hist(all_covar, breaks=50)
```


* It looks like most of our variables are independent of the others.  It is possible the surge in perfect correlation at the top is just due to groups with very small counts; so it's probably not worth looking much in to, we will examine some of the other items with a correlation of .6 or higher.

```{r}
head(all_covar[all_covar > .60 & all_covar < .999], 50)
sum(data_dummy[,'performancerating&3']) / 1470
print(sum(data[,'performancerating'] == 3))
sum(data[,'performancerating'] == 3 & data_binned[,'attrition'] == TRUE)
```

* It seems like there's a whole lot of fields which are highly correlated with a performance rating and a work life balance of 3.  Perhaps this is an indicator that a performance rating of 3 means very little.  In fact, it looks like 84% of all employees surveyed had a performance rating of 3.  Additionally, 16 percent of employees with a performance rating of 3 quit, which is nearly exactly in line with the population estimate.  Overall, this variable provides no significant information.


* Now let's take a look at enviroment satisfaction. 

```{r}

EnvSatTest_attrit <- Attrition_prop_table('environmentsatisfaction', data)
OverTime_attrit <- Attrition_prop_table( 'overtime',data)
years_worked_attrit <- Attrition_prop_table('totalworkingyears', data_binned)

ggplot(EnvSatTest_attrit, aes(x=attrition, y=value, fill= factor(environmentsatisfaction))) + 
    geom_bar(position = "fill",stat = "identity", width = 0.7) +
    labs(title = 'Attrition rate by\nEnvironment Satisfaction', y='Proportion of Response') +
    guides(fill=guide_legend(title="Environment \nSatisfaction"))+
    theme(legend.title=element_text(size = 9),plot.title=element_text(hjust=0.5))


```

* It appears that employees that quit are expected to have lower Environment Satisfaction than those who do not quit, but the distributions are not very different.

It is reasonable to suspect that Environment Satisfaction is correlated with overall happiness at work, so we would like to examine other factors that are correlated with Environment Satisfaction.

```{r}
data_binned[,'environmentsatisfaction'] <- data['environmentsatisfaction'] < 3
infl <- check_label_corelation(data_binned, 'environmentsatisfaction', '&', sd_ratio=.75)
head(infl, 10)
```

* It looks the the features most highly coorelated with environment satisfaction are a high monthly salary, having worked at one other company before, being at a company for a long time, feeling involved at your company, and having quit your job.  It seems to also help if you are a research director.


```{r}
sum(data['education'] == 1) / 1470
sum(data['education'] == 2) / 1470
sum(data['education'] == 3) / 1470
sum(data['education'] == 4) / 1470
```

* Moving onto education, we are presented with more evidence that this sample is not indicitive of the population.  Only 11 percent of those surveyed do not have a college degree, and .65 percent have a masters degree or higher; so because of our parciluar population, we are going to make the split at graduate school (so all employees with a masters degree or higher will be associated with the label TRUE)


```{r}
source('src/deason_functions.R')
data_binned[,'education'] <- data['education'] > 2
infl <- check_label_corelation(data_binned, 'education', '&', sd_ratio=.6)
head(infl, 10)
```


* The most interesting thing  here is that it seems 85% of those educated in HR have similar education levels. Closer examination indicates that most of these employees have at least a Bachelor's degree.  
* Similarly, working for multiple companies is correlated with education. Closer examination again indicates that these many of these employees have at least a Bachelor's degree.


```{r}
sum(data['relationshipsatisfaction'] == 1) / 1470
sum(data['relationshipsatisfaction'] == 2) / 1470
sum(data['relationshipsatisfaction'] == 3) / 1470
sum(data['relationshipsatisfaction'] == 4) / 1470
```

* Moving onto relationship satisfaction, it looks like 60% of people claim to be happy in thier relationship, so we will split this variable at the same place we've split the last two.  In this case we will say True if a relationship is at least a level 3 in satisfaction (or higher).

```{r}
data_binned[,'relationshipsatisfaction'] <- data['relationshipsatisfaction'] > 2
infl <- check_label_corelation(data_binned, 'relationshipsatisfaction', '&', sd_ratio=.5)
head(infl,10)
```

* Once agian human resources is right there at the top of our list both in job role, department, and education field, so apparently everyone in our test set who works in eduacation has a bachelors degree or higher, and is in a happy relationship.  There is also evidence that being happy in a realtionship is not corelated with how loyal you are to your job, as employees who have worked at 8 comapnies seem to be happy in thier relationship.  

```{r}
data_binned[,'relationshipsatisfaction'] <- data['relationshipsatisfaction'] > 3
infl <- check_label_corelation(data_binned, 'relationshipsatisfaction', '&', sd_ratio=.7)
head(infl)
```

* An interesting observation when we only count those who give a relationship satisfaction as 'very high' is that HR disappears from the top of our list.  Employees who are very happy in thier relationship apparently don't go to trainings, don't often get promoted, work at small companies, and are over 50.  Perhaps this is an indication that 3 is simply a baseline value people give for relationship satisfaction, and employees in Human Resources seem to avoid giving extreme answers.




```{r}
work_life_attrit <- Attrition_prop_table('worklifebalance', data)
ggplot(work_life_attrit, aes(x=attrition, y=value, fill= factor(worklifebalance))) + 
    geom_bar(position = "fill",stat = "identity", width = 0.7) +
    labs(title = 'Attrition rate by\nWork-life Balance', y='Proportion of Response') +
    guides(fill=guide_legend(title="Work-life \n Balance"))+
    theme(legend.title=element_text(size = 9),plot.title=element_text(hjust=0.5))
```

* Moving onto work life balance, it looks like ~70% of employees who do not quit claim to have a good work-life balance, compared to ~65% of those who quit.
* While work-life balance does not predict attrition well, employees with very poor work-life balance are more likely to quit.
```{r}
data_binned[,'worklifebalance'] <- data['worklifebalance'] > 3
infl <- check_label_corelation(data_binned, 'worklifebalance', '&', sd_ratio=.7)
head(infl)
```

* The correlation with work-life balance is not very strongly correlated with other, unlike the other variables examined.
* Interestingly, HR again appears as the Job Role most correlated with this variable.


