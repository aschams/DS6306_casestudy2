---
title: "case_study_2"
author: "Travis Deason"
date: "12/4/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, message=FALSE}
rm( list = ls()); cat("\014")  # Clear environment
#install.packages('tidyr')
#install.packages('dplyr')
#install.packages('ggplot2')
#install.packages('Hmisc')
#install.packages('plotly')
library(plotly)
library(Hmisc)
library(tidyr)
library(dplyr)
library(ggplot2)
require(reshape2)
require(plyr)
data <- read.csv('data/CaseStudy2-data.csv')
# Remove the & from the factor level
data$Department <- revalue(data$Department, c('Human Resources' = 'Human Resources', 'Research & Development'='Research/Development', 'Sales'='Sales'))
describe_data <- read.csv('data/CaseStudy2-descriptions.csv')
#names(describe_data) <- (names(describe_data), tolower)
names(data) <- sapply(names(data), tolower)

```
## Project Goals

* Identify (at least) the top three factors that contribute to turnover.

* Learn about any job role specific trends that may exist in the data set

* Provide any other interesting trends and observations from your analysis

```{r echo=TRUE }
## this doesn't really seem needed yet... just know lower is better
labels <- sapply(unique(describe_data$X), tolower)
describe_clean <- fill(describe_data, X, .direction='up')
dump <- describe_data[6,1]
is(dump)
```

```{r echo=TRUE}
str(data)
```

* Because we have a mix of catagoriacal and numerical data in here, I am going to split every integer column into binned values

```{r}
types <- sapply(data, class)
data_binned <- data
for(col in names(types)){
  if(types[[col]] == 'integer' & length(unique(data[,col])) > 10){
    data_binned[col] <- cut2(data[[col]], m=100, g=10)
  }
}
```

* Now, lets find out the base attrition rate

```{r}
na_count <- sum(is.na(data$attrition))
## convert data Attrition to binary
data_binned$attrition <- data$attrition == 'Yes'
## N/A Count
print(sum(na_count))
## Sum of Employees who quit
print(sum(data_binned$attrition))
## retain ratio
overall_ratio <- sum(data_binned$attrition) / length(data_binned$attrition)
print(overall_ratio)
```



* So, there are no N/A values in attrition
* 237 total employees quit out of 1470 total (which is 16.122 percent)


* Now (Since we have binned all continous values) lets treat all values as catagorical, and find out which of them have a higher then expected corelation with

* First we will create a vector which contains the lengths of all catagories, or factors

```{r}
num_obs= c()
for (col in names(data_binned))
 ## this is not needed since there are no N/A values in the dataset
 # unique_vals[paste(col, 'isna', sep='#')] = sum(is.na(data[,col])) / 1470
  {for (value in unique(data_binned[,col]))
    {
    num_obs[paste(col, value, sep='&')] = sum(data_binned[,col] == value)
    }
}
print(mean(num_obs))

obs_stacked = stack(num_obs)
ggplot(obs_stacked, aes(x = values)) +
  stat_density(position="identity",geom="line")
```

*It looks like we have 216 possible factors with an mean of 238 observations each, and most factors seem to have around ~170 variables, so we are fairly well distributed, but it would be nice if one of those factors with 1000+ had a zero attrition rate

```{r}
## first we will define a function to build a new data.frame which contains qutting percent and number of observations for each factor
percent_quit = c()
find_percent <- function(df, sub_df, col_value, num_observations)
  {
  colval <- unlist(strsplit(col_value, '&'))
  return(sum(sub_df[,colval[1]] == colval[2])  / num_observations)
}

## Then we can iterate over all our factors and extract the data we are looking for from them
percent_quit = c()
sub_df <- subset(data_binned, attrition == TRUE)
for (colval in names(num_obs)){
  percent_quit[colval] = find_percent(data_binned, sub_df, colval, num_obs[colval])}
```


```{r}
print(mean(percent_quit))
print(median(percent_quit))
per_stacked = stack(percent_quit)
ggplot(per_stacked, aes(x = values)) +
  stat_density(position="identity",geom="line")
```

* Unsuprisingly, our mean value for percent_quit is exactly in line with the overall percent who quit, but the median value is notably lower, and we seem to have a small cluster of events hovering around .33% quit; which is approximitly double the standard rate

* Let's take a closer look at some of those varaibles

```{r}
## move all our data into a dataframe of percent_quit verses number of observations
attr_frame <- data.frame(percent_quit, num_obs)
high_prob <- subset(attr_frame, percent_quit > overall_ratio)
high_prob$ratio_delta = high_prob$percent_quit - overall_ratio
hnames <- rownames(high_prob) != 'attrition&TRUE'
high_prob <- high_prob[hnames,]
head(high_prob[order(-high_prob$ratio_delta),], 40)
```

* We see that Sales Representatives is the group with the highest leaving rate. 
* The next 3 highest groups are young people with little experience, both in working years and at the company. These three groups are not independent.
* A high number of people leave at 0 years with their current manager. This could be related to inexperience/age or incompatibility with the manager.
* People with low salaries leave at a higher rate. This again could be confounded in age/experience.

It is also important to examine what factors are associated with not quitting.
```{r}
head(attr_frame[order(attr_frame$percent_quit),], 20)
```

* Research Directors have an incredibly low rate of attrition.
* Employees in the highest income bracket rarely quit.
* Employees that have worked the same role with the same manager for about a decade rarely quit.

Many of these attributes are likely correlated.


```{r}
#function which asssumes all data is catagorical within the dataframe
make_dummy <- function(df){
  for(col in names(df)){
    for(val in unique(df[,col])){
      df[, paste(col, val, sep='&')] = df[, col] = val
    }
   df = df[, names(df) != col]
  }
 return(df)
}
#thirtyfive <- data_binned[,colnames(subset(high_prob, percent_quit > 0.33))]
data_dummy <- make_dummy(data_binned)
```


```{r}
find_covariance <- function(df){
  covar = c()
  for(col1 in names(df)){
    for(col2 in names(df)){
      covar[paste(col1, col2, sep='+')] = sum(col1 == TRUE & col2 == TRUE) / sum(col1 == TRUE)
    }
   df <- df[, names(df) != col]
  }
}
over_34 <- subset(high_prob, percent_quit > .34)
```





```{r}
hist(data$percentsalaryhike, main = 'Percent of Salary Hike')
ggplot(data = data, aes(numcompaniesworked)) + 
    geom_histogram(binwidth=1)
hist(data$environmentsatisfaction, main = 'Environmental Satisfaction' )
hist(data$totalworkingyears, main='Total Working Years' )
```


* Taking care of all the catagorical variables

```{r}
print(unique(data$businesstravel)) # sequential data, can be assigned nums
print(unique(data$department)) ## Dummy for:
## Sales                  Research & Development Human Resources       
## Human Resources Research & Development Sales
print(unique(data$educationfield)) ## Dummy for:
## Life Sciences    Other            Medical          Marketing        Technical Degree
## Default: Human Resources
print(unique(data$gender)) ## Dummy value for is_female
print(unique(data$jobrole)) ## Dummy for:
## Sales Executive           Research Scientist        Laboratory Technician  
## Manufacturing Director    Healthcare Representative Manager      
## Sales Representative      Research Director
## Default: Human Resources
print(unique(data$maritalstatus)) # dummy for married or divorced; single=default
print(unique(data$over18)) # there is only one level, omit this variable
print(unique(data$overtime)) #create dummy variable for yes overtime
```


```{r}
#check_corr <- function(col, label)
```


```{r}

Attrition_prop_table <- function(variable_name, data.f){
    # Generates a table containing proportion of responses for both Attrition values. This should allow us to examine values in the context of whether they attrified.
    
    # Generate a table containing variable/Attrition rates
    prop <-prop.table(xtabs(as.formula(paste( '~ ',paste(variable_name, 'attrition ', sep = ' + '))) , data=data.f))
    
    #Normalize each column to sum to 1.
    prop.app <-apply(prop,2,sum)
    return(melt(sweep(prop, MARGIN=2,prop.app,'/')))
}


EnvSatTest_attrit <- Attrition_prop_table('environmentsatisfaction', data)
OverTime_attrit <- Attrition_prop_table( 'overtime',data)
years_worked_attrit <- Attrition_prop_table('totalworkingyears', data_binned)

ggplot(EnvSatTest_attrit, aes(x=attrition, y=value, fill= factor(environmentsatisfaction))) + 
    geom_bar(position = "fill",stat = "identity") +
    labs(title = 'Attrition rate by\nEnvironment Satisfaction', y='Proportion of Response') +
    guides(fill=guide_legend(title="Environment \nSatisfaction"))+
    theme(legend.title=element_text(size = 9),plot.title=element_text(hjust=0.5))



ggplot(OverTime_attrit, aes(x=attrition, y=value, fill= factor(overtime))) + 
    geom_bar(position = "fill",stat = "identity") +
    labs(title = 'Attrition rate based on Overtime', y='Proportion of Response') +
    guides(fill=guide_legend(title="Overtime"))+
    theme(legend.title=element_text(size = 9),plot.title=element_text(hjust=0.5))

ggplot(years_worked_attrit, aes(x=attrition, y = value, fill= factor(totalworkingyears))) +
    geom_bar(position='fill', stat = 'identity')+
    labs(title='Attrition vs. Number of Years Working', y = 'Proportion') +
    guides(fill=guide_legend(title='Years Worked\n in Life')) + 
    theme(legend.title=element_text(size=9), plot.title=element_text(hjust=0.5))


bg<-ggplot(data, aes(x=overtime,fill=attrition))
bg<-bg + geom_bar(position = "fill")
bg<-bg + scale_y_continuous(labels = scales::percent)
bg<-bg + labs(y="Percentage", x="Over Time", title="Attrition vs Overtime")
bg
```

